# Multi-Cluster GitOps with Kargo & ArgoCD

## What This Demonstrates

A working **multi-cluster GitOps pipeline** using:
- **Kargo** for GitOps promotion workflows  
- **ArgoCD** for cross-cluster deployment
- **GKE Fleet + Connect Gateway** for secure cluster access across Google Cloud projects
- **Workload Identity** for authentication

## Current Status: âœ… WORKING

All applications deployed and healthy across both clusters:

```
CLUSTER    APPLICATION              STATUS
use1       guestbook-dev-use1       Synced/Healthy  
use1       guestbook-staging-use1   Synced/Healthy
use1       guestbook-prod-use1      Synced/Healthy
use4       guestbook-dev-use4       Synced/Healthy  
use4       guestbook-staging-use4   Synced/Healthy
use4       guestbook-prod-use4      Synced/Healthy
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Fleet Host Project          â”‚    â”‚    Target Cluster Project       â”‚
â”‚  sap-ems-central-monitoring-poc â”‚    â”‚   sap-ems-gap-sandbox-net      â”‚
â”‚                                 â”‚    â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Control Cluster (use4)    â”‚â”‚    â”‚ â”‚   Target Cluster (use1)     â”‚ â”‚
â”‚  â”‚                             â”‚â”‚    â”‚ â”‚                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚    â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚  Kargo  â”‚ â”‚   ArgoCD   â”‚ â”‚â”‚    â”‚ â”‚  â”‚    Applications        â”‚â”‚ â”‚
â”‚  â”‚  â”‚         â”‚ â”‚            â”‚ â”‚â”‚â”€â”€â”€â”€â”¼â”€â”¼â”€â–¶â”‚  â€¢ guestbook-dev       â”‚â”‚ â”‚
â”‚  â”‚  â”‚ Promote â”‚ â”‚ Deploy     â”‚ â”‚â”‚    â”‚ â”‚  â”‚  â€¢ guestbook-staging   â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚    â”‚ â”‚  â”‚  â€¢ guestbook-prod      â”‚â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         Connect Gateway: connectgateway.googleapis.com/.../gap-staging-use1
```

### 1. GKE Fleet Configuration
- **Fleet Host Project**: `sap-ems-central-monitoring-poc` (project ID: 90257023985)
- **Control Cluster**: `gap-staging-use4` (hosts Kargo + ArgoCD)
- **Target Cluster**: `gap-staging-use1` in `sap-ems-gap-sandbox-net` (project ID: 90608020739)
- **Fleet Membership**: Registered with Connect Gateway in `us-east1` location

### 2. Connect Gateway Setup
- **Authentication**: Workload Identity with Google Service Account
- **Service Account**: `argocd-fleet-access@sap-ems-central-monitoring-poc.iam.gserviceaccount.com`
- **Gateway URL**: `https://connectgateway.googleapis.com/v1beta1/projects/90257023985/locations/us-east1/gkeMemberships/gap-staging-use1`

### 3. Kargo Workflow
- **Image Repository**: `us-east4-docker.pkg.dev/sap-ems-gap-sandbox/use4-misc-images/guestbook`
- **Promotion Pipeline**: dev â†’ staging â†’ prod
- **Cross-cluster**: Promotes to both local (use4) and remote (use1) clusters

## Requirements

* Kargo v1.3.x (for older Kargo versions, switch to the release-X.Y branch)
* ArgoCD installed on control cluster
* Connect Gateway APIs enabled on both projects
* Proper IAM roles and Workload Identity configuration

## Directory Structure

```
kargo-simple/
â”œâ”€â”€ README.md                           # This file  
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ SETUP-GUIDE.md                 # Step-by-step setup instructions
â”‚   â”œâ”€â”€ CLUSTER-CONFIGURATIONS.md      # Per-cluster configuration details
â”‚   â”œâ”€â”€ API-IAM-REQUIREMENTS.md        # Required APIs and IAM roles
â”‚   â”œâ”€â”€ ARGOCD-WORKLOAD-IDENTITY.md    # ArgoCD Workload Identity configuration
â”‚   â”œâ”€â”€ NETWORK-CONFIGURATION.md       # Network restrictions & whitelist nodepool setup
â”‚   â”œâ”€â”€ PROJECT-SUMMARY.md             # Project overview and achievements
â”‚   â”œâ”€â”€ CURRENT-STATUS.md              # Current operational status
â”‚   â””â”€â”€ VALIDATION-REPORT.md           # Live vs documentation verification
â”œâ”€â”€ argocd/
â”‚   â”œâ”€â”€ applications/                  # ArgoCD application definitions
â”‚   â”‚   â”œâ”€â”€ guestbook-applications-use1.yaml
â”‚   â”‚   â”œâ”€â”€ guestbook-applications-use4.yaml
â”‚   â”‚   â””â”€â”€ nizarhelmi-repo-credentials.yaml
â”‚   â””â”€â”€ clusters/                      # Cluster connection configs (reference)
â”‚       â”œâ”€â”€ use1.yaml                 # Connect Gateway config for remote cluster
â”‚       â””â”€â”€ use4.yaml                 # Reference config (not used, local cluster)
â”œâ”€â”€ kargo/                            # Kargo workflow configuration
â”‚   â”œâ”€â”€ project.yaml                  # Kargo project definition
â”‚   â”œâ”€â”€ warehouse.yaml                # Container image warehouse
â”‚   â”œâ”€â”€ stages.yaml                   # Promotion stages (dev/staging/prod)
â”‚   â””â”€â”€ promotiontask.yaml            # Custom promotion tasks
â”œâ”€â”€ base/                             # Base Kubernetes manifests
â”‚   â”œâ”€â”€ guestbook-deploy.yaml
â”‚   â”œâ”€â”€ guestbook-svc.yaml
â”‚   â”œâ”€â”€ guestbook-ns.yaml
â”‚   â””â”€â”€ kustomization.yaml
â””â”€â”€ env/                              # Environment overlays
    â”œâ”€â”€ dev/
    â”œâ”€â”€ staging/
    â””â”€â”€ prod/
```

## Quick Start

1. **Prerequisites**: Ensure you have the required APIs enabled and IAM roles configured (see `docs/API-IAM-REQUIREMENTS.md`)

2. **Deploy Kargo and ArgoCD**:
   ```bash
   kubectl apply -f kargo/
   kubectl apply -f argocd/applications/
   ```

3. **Verify Setup**: Check that all applications are healthy and synced:
   ```bash
   kubectl get applications -n argocd
   ```

4. **Test the Setup**: Create a promotion to verify the multi-cluster workflow:
   ```bash
   kargo promote --stage=staging --project=gke-fleet
   ```

## Features Demonstrated

- âœ… **Cross-project cluster access** using Connect Gateway
- âœ… **Workload Identity authentication** for secure access  
- âœ… **Multi-cluster application deployment** via ArgoCD
- âœ… **GitOps promotion workflows** using Kargo
- âœ… **Container image management** with Artifact Registry
- âœ… **Network restrictions** support (whitelist nodes)
- âœ… **IAM-based authentication** for service accounts

## Troubleshooting

### Common Issues
1. **"error synchronizing cache state : unknown"**: Missing Connect Gateway API on cluster project
2. **Image pull errors**: Artifact Registry permissions not granted to cluster service account  
3. **Authentication failures**: Workload Identity not properly configured
4. **Pod scheduling failures**: Check node selectors and taints for network restrictions

### Debug Commands
```bash
# Check ArgoCD logs
kubectl logs argocd-application-controller-0 -n argocd --tail=50

# Verify Connect Gateway connectivity  
kubectl exec -it argocd-application-controller-0 -n argocd -- curl -s "https://connectgateway.googleapis.com/v1beta1/projects/90257023985/locations/us-east1/gkeMemberships/gap-staging-use1"

# Check application status
kubectl get application -n argocd
kubectl describe application guestbook-dev-use1 -n argocd
```

For detailed setup instructions, see [docs/SETUP-GUIDE.md](docs/SETUP-GUIDE.md).

## ğŸ“Š Current Status

**All systems operational!** See [docs/CURRENT-STATUS.md](docs/CURRENT-STATUS.md) for the latest status report and validation commands.
